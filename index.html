<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sentence Trainer</title>
  <style>
    :root{
      --bg:#0f172a; --fg:#e2e8f0; --muted:#94a3b8; --accent:#22d3ee;
      --good:#34d399; --warn:#fbbf24; --danger:#fb7185; --card:#111827; --btn:#1f2937;
    }
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 70% -20%, #1e293b, transparent), var(--bg);
      color:var(--fg); display:grid; place-items:center;
    }
    .app{ width:min(1200px,94vw); }
    .card{ background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));
           border:1px solid rgba(255,255,255,0.08); border-radius:18px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1{ margin:0 0 12px; font-weight:800; letter-spacing:.2px; }
    p.muted{ color:var(--muted); margin-top:6px }
    textarea{ width:100%; min-height:240px; border-radius:12px; background:#0b1220; color:var(--fg);
              border:1px solid rgba(255,255,255,0.12); padding:14px; font-size:18px; line-height:1.5; resize:vertical; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .btn{ background:var(--btn); color:#fff; border:1px solid rgba(255,255,255,0.14); padding:12px 16px; border-radius:12px; font-size:16px;
          cursor:pointer; transition:transform .06s ease, background .2s ease, border-color .2s ease; }
    .btn:hover{ transform:translateY(-1px); border-color:rgba(255,255,255,0.25) }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none }
    .btn.primary{ background:linear-gradient(180deg,#22d3ee,#06b6d4); color:#00212a; font-weight:700; border:none }
    .btn.ghost{ background:transparent; border:1px dashed rgba(255,255,255,.25) }
    .pill{ padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.15); background:#0b1220; color:#e2e8f0; font-size:12px }
    .viewer{ display:none }
    .hud{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px }
    .count{ font-variant-numeric:tabular-nums; letter-spacing:1px; font-weight:800; }
    .count.badge{ background:#0b1220; border:1px solid rgba(255,255,255,0.12); padding:8px 12px; border-radius:999px }
    .count.show{ color:var(--good) } .count.blank{ color:var(--warn) } .count.idle{ color:var(--muted) }
    .progress{ height:6px; background:#0b1220; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.08) }
    .progress > div{ height:100%; width:0%; background:linear-gradient(90deg,#22d3ee,#34d399); transition:width .1s linear }
    .sentence{ font-size:clamp(28px,5vw,54px); line-height:1.2; text-align:center; min-height:6lh; display:grid; place-items:center;
               padding:28px; border-radius:18px; border:1px solid rgba(255,255,255,.08);
               background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01)); }
    .write{ font-weight:900; letter-spacing:2px; font-size:clamp(34px,6vw,72px); color:var(--accent); text-align:center }
    .footer{ display:flex; justify-content:space-between; align-items:center; margin-top:14px; gap:12px; flex-wrap:wrap }
    .index{ color:var(--muted) }
    .kbd{ font-variant-numeric:tabular-nums; background:#0b1220; border:1px solid rgba(255,255,255,.15); padding:2px 6px; border-radius:6px }
    .invisible-ink{ color:var(--bg) !important; text-shadow:none !important; }
    #err{ display:none; background:#7f1d1d; color:#fee2e2; border:1px solid #fecaca; padding:8px 10px; border-radius:8px; margin:10px 0; }
    @media (max-width:600px){ .sentence{ min-height:5lh } }
  </style>
</head>
<body>
  <div class="app">
    <div id="err"></div>

    <!-- Setup screen -->
    <section id="setup" class="card">
      <h1>Sentence Trainer</h1>
      <p class="muted">Paste one sentence per line. Flow: <em>Show</em> â†’ <em>Blank</em> â†’ <strong>WRITE</strong> â†’ <em>Show again</em> â†’ Next. Use <span class="kbd">Space</span> for Next.</p>
      <textarea id="input" placeholder="Type one sentence per lineâ€¦&#10;Ich spiele gern FuÃŸball.&#10;Am Wochenende besuche ich meine GroÃŸeltern."></textarea>

      <!-- Difficulty presets -->
      <div class="card" style="margin-top:14px">
        <h2 style="margin:0 0 8px;font-size:18px">Difficulty / Timers</h2>
        <div class="row" style="margin-bottom:8px">
          <button type="button" class="btn" data-preset="beginner">Beginner 8s/5s</button>
          <button type="button" class="btn" data-preset="standard">Standard 5s/3s</button>
          <button type="button" class="btn" data-preset="advanced">Advanced 3s/2s</button>
          <span class="pill" id="currentPreset">Current: Standard</span>
        </div>
        <div class="row">
          <label>Show <input id="showSec" type="number" min="1" max="30" value="5" style="width:80px"> s</label>
          <label>Blank <input id="blankSec" type="number" min="1" max="30" value="3" style="width:80px"> s</label>
          <button type="button" id="saveTiming" class="btn">Save timing</button>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h2 style="margin:0 0 8px;font-size:18px">Text-to-Speech (optional)</h2>
        <p class="muted" id="ttsSupportNote">Enable this to read sentences aloud during the Show/Repeat phases.</p>
        <div class="row" id="ttsControls">
          <label class="row" style="gap:8px;align-items:center">
            <input type="checkbox" id="ttsEnabled"><span>Read sentences aloud</span>
          </label>
          <select id="voiceSelect" title="Voice" disabled></select>
          <label>Rate <input type="range" id="rate" min="0.5" max="1.5" step="0.1" value="1" disabled></label>
          <label>Pitch <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1" disabled></label>
          <button type="button" id="testVoice" class="btn" disabled>Test voice</button>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h2 style="margin:0 0 8px;font-size:18px">Exam layout</h2>
        <label class="row" style="gap:8px;align-items:center">
          <input type="checkbox" id="listeningOnly">
          <span>Listening only (hide text during memorisation). <span class="muted">Note: hides by blending text into background; TTS still plays.</span></span>
        </label>
      </div>

      <div class="row" style="margin-top:12px">
        <button type="button" id="startBtn" class="btn primary">OK</button>
        <button type="button" id="demoBtn" class="btn">Load demo</button>
        <button type="button" id="clearBtn" class="btn ghost">Clear</button>
      </div>
    </section>

    <!-- Viewer screen -->
    <section id="viewer" class="viewer">
      <div class="hud">
        <div class="index" id="indexLabel">Sentence 1 / 1</div>
        <div class="row" style="margin-left:auto;gap:8px;align-items:center">
          <button type="button" id="replayBtn" class="btn" title="Replay sentence audio">âŸ³ Replay</button>
          <button type="button" id="muteBtn" class="btn" title="Mute / unmute TTS">ðŸ”Š</button>
          <div class="count badge idle" id="countdown">Ready</div>
        </div>
      </div>
      <div class="progress" aria-hidden="true"><div id="bar"></div></div>

      <div id="stage" class="sentence" role="region" aria-live="polite"></div>

      <div class="footer">
        <div class="row">
          <button type="button" id="nextBtn" class="btn" disabled>Next â–¸</button>
          <button type="button" id="restartBtn" class="btn">â†» Restart</button>
          <button type="button" id="backBtn" class="btn">â—‚ Back to input</button>
        </div>
        <div class="muted">Tip: <span class="kbd">Space</span> for Next</div>
      </div>
    </section>
  </div>

  <script>
    // Show runtime errors right on the page (handy on iPad)
    (function(){
      const errBox = document.getElementById('err');
      window.addEventListener('error', e => {
        errBox.style.display='block';
        errBox.textContent = 'Error: ' + (e.message || e.error || e);
      });
      window.addEventListener('unhandledrejection', e => {
        errBox.style.display='block';
        errBox.textContent = 'Promise error: ' + (e.reason && e.reason.message || e.reason || e);
      });
    })();

    document.addEventListener('DOMContentLoaded', () => {
      // --- Grab elements
      const setup = document.getElementById('setup');
      const viewer = document.getElementById('viewer');
      const input = document.getElementById('input');
      const startBtn = document.getElementById('startBtn');
      const demoBtn = document.getElementById('demoBtn');
      const clearBtn = document.getElementById('clearBtn');

      const indexLabel = document.getElementById('indexLabel');
      const stage = document.getElementById('stage');
      const countdown = document.getElementById('countdown');
      const bar = document.getElementById('bar');
      const nextBtn = document.getElementById('nextBtn');
      const restartBtn = document.getElementById('restartBtn');
      const backBtn = document.getElementById('backBtn');
      const replayBtn = document.getElementById('replayBtn');
      const muteBtn = document.getElementById('muteBtn');

      const showSec = document.getElementById('showSec');
      const blankSec = document.getElementById('blankSec');
      const currentPreset = document.getElementById('currentPreset');
      const saveTiming = document.getElementById('saveTiming');

      const listeningOnly = document.getElementById('listeningOnly');

      const ttsEnabled = document.getElementById('ttsEnabled');
      const voiceSelect = document.getElementById('voiceSelect');
      const rateInput = document.getElementById('rate');
      const pitchInput = document.getElementById('pitch');
      const testVoiceBtn = document.getElementById('testVoice');

      if (!setup || !startBtn || !demoBtn || !clearBtn) {
        const errBox = document.getElementById('err');
        errBox.style.display='block';
        errBox.textContent = 'Init error: one or more controls not found in the DOM.';
        return;
      }

      // --- State
      let sentences = [], i = 0, phase = 'idle', timer = null, t0 = 0;
      let showMs = 5000, blankMs = 3000;
      let listening = false;
      const tts = { enabled:false, muted:false, voice:null, rate:1, pitch:1, volume:1 };

      // --- Helpers
      function parseSentences(text){
        return text.split(/\r?\n|\r/).map(s=>s.trim()).filter(Boolean);
      }
      function updateIndex(){ indexLabel.textContent = `Sentence ${i+1} / ${sentences.length}`; }
      function setCountdownLabel(txt, cls){ countdown.textContent = txt; countdown.className = `count badge ${cls}`; }
      function animateBar(p){ bar.style.width = `${Math.max(0, Math.min(100, p*100))}%`; }
      function startTimer(ms, label, cls, done){
        clearInterval(timer); t0 = performance.now(); animateBar(0);
        timer = setInterval(()=>{
          const el = performance.now() - t0; const remain = Math.max(0, ms - el);
          setCountdownLabel(`${label}: ${Math.ceil(remain/1000)}s`, cls);
          animateBar(el/ms);
          if(remain<=0){ clearInterval(timer); animateBar(1); done && done(); }
        }, 100);
      }
      function showSentenceText(on){ stage.classList.toggle('invisible-ink', !on); }

      // --- TTS
      function loadVoices(){
        if(!('speechSynthesis' in window)) return;
        const voices = window.speechSynthesis.getVoices();
        voiceSelect.innerHTML = '';
        for(const v of voices){
          const o=document.createElement('option'); o.value=v.name; o.textContent=`${v.name} (${v.lang})`; voiceSelect.appendChild(o);
        }
        const saved = localStorage.getItem('sentence-trainer:voice');
        if(saved){ voiceSelect.value = saved; tts.voice = voices.find(v=>v.name===saved)||null; }
        else if(voices.length){ const pref = voices.find(v=>/^de|^en/i.test(v.lang)) || voices[0]; tts.voice = pref; voiceSelect.value = pref?.name || ''; }
      }
      function setTTSControlsEnabled(on){
        [voiceSelect, rateInput, pitchInput, testVoiceBtn, muteBtn, replayBtn].forEach(el => { if(el) el.disabled = !on; });
      }
      function speak(text){
        if(!tts.enabled || tts.muted || !('speechSynthesis' in window)) return;
        try{ window.speechSynthesis.cancel(); }catch(e){}
        const u=new SpeechSynthesisUtterance(text);
        if(tts.voice) u.voice=tts.voice; u.rate=tts.rate; u.pitch=tts.pitch; u.volume=tts.volume;
        window.speechSynthesis.speak(u);
      }
      function stopSpeak(){ if('speechSynthesis' in window) try{ window.speechSynthesis.cancel(); }catch(e){} }
      function speakCurrent(){ if(sentences[i]) speak(sentences[i]); }

      // --- Flow
      function gotoViewer(list){
        sentences = list; i = 0;
        setup.style.display='none';
        viewer.style.display='block';
        startSentenceCycle();
      }

      function startSentenceCycle(){
        if(i>=sentences.length){
          stage.innerHTML = `<div class="write">All done âœ…</div>`;
          setCountdownLabel('Complete','idle');
          nextBtn.disabled=true; animateBar(0); stopSpeak();
          return;
        }
        updateIndex();
        // Show
        phase='show';
        stage.textContent = sentences[i];
        showSentenceText(!listening);
        stopSpeak(); speakCurrent();
        nextBtn.disabled = true;
        startTimer(showMs,'Show','show',()=>{
          // Blank
          phase='blank';
          stage.textContent=''; showSentenceText(true); stopSpeak();
          startTimer(blankMs,'Blank','blank',()=>{
            // Write (visual only)
            phase='write';
            stage.innerHTML = `<div class="write">WRITE</div>`;
            setCountdownLabel('Wait for Next','idle'); animateBar(0);
            nextBtn.disabled = false;
            showSentenceText(true);
          });
        });
      }

      function handleNext(){
        if(phase==='write'){
          phase='again';
          stage.textContent = sentences[i];
          showSentenceText(!listening);
          setCountdownLabel('Repeat shown','idle'); animateBar(0);
          stopSpeak(); speakCurrent();
          nextBtn.disabled = false;
        } else if(phase==='again'){
          i++; startSentenceCycle();
        }
      }

      // --- Events
      startBtn.addEventListener('click', ()=>{
        try{
          const list = parseSentences(input.value);
          if(!list.length){ alert('Please add at least one sentence.'); return; }
          localStorage.setItem('sentence-trainer:last', JSON.stringify(list));
          listening = !!listeningOnly.checked;
          gotoViewer(list);
        }catch(e){
          const errBox=document.getElementById('err'); errBox.style.display='block'; errBox.textContent='Start error: '+e.message;
        }
      });

      demoBtn.addEventListener('click', ()=>{
        input.value = [
          'Ich mag Mathe, weil es logisch ist.',
          'Am Montag habe ich Deutsch.',
          'Wir spielen FuÃŸball nach der Schule.',
          'Im Sommer fahre ich nach Spanien.'
        ].join('\n');
      });

      clearBtn.addEventListener('click', ()=>{ input.value=''; input.focus(); });

      nextBtn.addEventListener('click', handleNext);
      restartBtn.addEventListener('click', ()=>{ clearInterval(timer); stopSpeak(); startSentenceCycle(); });
      backBtn.addEventListener('click', ()=>{ clearInterval(timer); stopSpeak(); viewer.style.display='none'; setup.style.display='block'; nextBtn.disabled=true; stage.textContent=''; animateBar(0); });

      replayBtn.addEventListener('click', ()=>{ stopSpeak(); speakCurrent(); });

      window.addEventListener('keydown', (e)=>{
        if(e.code==='Space'){
          const a=document.activeElement;
          if(a && (a.tagName==='TEXTAREA'||a.tagName==='INPUT')) return;
          e.preventDefault();
          if(viewer.style.display==='block' && !nextBtn.disabled) handleNext();
        }
      });

      // Timers: presets & persistence
      function applyPreset(name){
        let s=5,b=3,label='Standard';
        if(name==='beginner'){ s=8; b=5; label='Beginner'; }
        if(name==='advanced'){ s=3; b=2; label='Advanced'; }
        showSec.value=s; blankSec.value=b; currentPreset.textContent=`Current: ${label}`;
        persistTiming(); loadTiming();
      }
      document.querySelectorAll('[data-preset]').forEach(btn => btn.addEventListener('click', ()=>applyPreset(btn.dataset.preset)));
      function persistTiming(){ localStorage.setItem('sentence-trainer:show', showSec.value); localStorage.setItem('sentence-trainer:blank', blankSec.value); }
      function loadTiming(){
        const s=parseInt(localStorage.getItem('sentence-trainer:show')||showSec.value,10);
        const b=parseInt(localStorage.getItem('sentence-trainer:blank')||blankSec.value,10);
        showSec.value=s; blankSec.value=b;
        showMs=Math.max(1,s)*1000; blankMs=Math.max(1,b)*1000;
      }
      saveTiming.addEventListener('click', ()=>{ persistTiming(); loadTiming(); currentPreset.textContent='Current: Custom'; });

      // TTS init & controls
      function setTTSUIEnabled(on){
        [voiceSelect, rateInput, pitchInput, testVoiceBtn, muteBtn, replayBtn].forEach(el=>{ if(el) el.disabled=!on; });
      }
      ttsEnabled.addEventListener('change', ()=>{ tts.enabled=ttsEnabled.checked; setTTSUIEnabled(tts.enabled); localStorage.setItem('sentence-trainer:tts', tts.enabled?'1':'0'); if(!tts.enabled) stopSpeak(); });
      voiceSelect.addEventListener('change', ()=>{ const name=voiceSelect.value; const list=(window.speechSynthesis&&window.speechSynthesis.getVoices())||[]; tts.voice=list.find(v=>v.name===name)||null; localStorage.setItem('sentence-trainer:voice', name||''); });
      rateInput.addEventListener('input', ()=>{ tts.rate=parseFloat(rateInput.value)||1; localStorage.setItem('sentence-trainer:rate', String(tts.rate)); });
      pitchInput.addEventListener('input', ()=>{ tts.pitch=parseFloat(pitchInput.value)||1; localStorage.setItem('sentence-trainer:pitch', String(tts.pitch)); });
      testVoiceBtn.addEventListener('click', ()=>{ stopSpeak(); speak('This is a test of the selected voice.'); });
      muteBtn.addEventListener('click', ()=>{ tts.muted=!tts.muted; localStorage.setItem('sentence-trainer:muted', tts.muted?'1':'0'); muteBtn.textContent = tts.muted ? 'ðŸ”ˆ' : 'ðŸ”Š'; if(tts.muted) stopSpeak(); });

      // First-run init (inside try so we donâ€™t block buttons if something fails)
      try{
        const last = JSON.parse(localStorage.getItem('sentence-trainer:last')||'null');
        if(Array.isArray(last) && last.length){ input.value = last.join('\n'); }

        tts.enabled = localStorage.getItem('sentence-trainer:tts')==='1';
        tts.rate = parseFloat(localStorage.getItem('sentence-trainer:rate')||'1')||1;
        tts.pitch = parseFloat(localStorage.getItem('sentence-trainer:pitch')||'1')||1;
        tts.muted = localStorage.getItem('sentence-trainer:muted')==='1';
        ttsEnabled.checked = tts.enabled; rateInput.value=tts.rate; pitchInput.value=tts.pitch;
        setTTSUIEnabled(tts.enabled); muteBtn.textContent = tts.muted ? 'ðŸ”ˆ' : 'ðŸ”Š';

        if('speechSynthesis' in window){
          loadVoices();
          window.speechSynthesis.onvoiceschanged = loadVoices;
        } else {
          document.getElementById('ttsSupportNote').innerHTML = 'Your browser does not support Text-to-Speech.';
        }
        loadTiming();
      }catch(e){
        const errBox=document.getElementById('err'); errBox.style.display='block'; errBox.textContent='Init error: '+e.message;
      }

      // Self-tests (console)
      (function tests(){
        const cases=[
          {name:'LF only',  input:'A\nB\n\n C ', expected:['A','B','C']},
          {name:'CRLF',     input:'A\r\nB\r\n\r\nC', expected:['A','B','C']},
          {name:'CR only',  input:'A\rB\r\rC', expected:['A','B','C']},
          {name:'Trim & blanks', input:'  A  \n\n  B  \n\n', expected:['A','B']},
          {name:'Trailing newline', input:'A\nB\n', expected:['A','B']}
        ];
        let pass=0; for(const t of cases){ const out=parseSentences(t.input); const ok=JSON.stringify(out)===JSON.stringify(t.expected); console[ok?'log':'error'](`[parse] ${t.name}: ${ok?'PASS':'FAIL'}`, {out, expected:t.expected}); if(ok) pass++; }
        console.log(`[tests] ${pass}/${cases.length} parseSentences tests passed`);
      })();
    });
  </script>
</body>
</html>
